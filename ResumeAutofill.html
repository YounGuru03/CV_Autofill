<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resume Autofill - AI-Powered Resume Optimizer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 30px;
        }

        h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2em;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .section h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.4em;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        input[type="text"],
        input[type="email"],
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus,
        input[type="email"]:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
        }

        .btn {
            background: #667eea;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 14px;
        }

        .array-item {
            background: white;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 6px;
            border: 1px solid #ddd;
            position: relative;
        }

        .remove-btn {
            position: absolute;
            top: 10px;
            right: 10px;
        }

        .api-section {
            background: #fff3cd;
            border-left-color: #ffc107;
        }

        .job-analysis-section {
            background: #d1ecf1;
            border-left-color: #17a2b8;
        }

        .actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideDown 0.3s;
        }

        @keyframes slideDown {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 20px;
        }

        .close:hover {
            color: #000;
        }

        .preview-section {
            margin-bottom: 20px;
        }

        .preview-section h3 {
            color: #667eea;
            margin-bottom: 10px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 5px;
        }

        .preview-item {
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .code-block {
            background: #282c34;
            color: #abb2bf;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            margin: 10px 0;
            position: relative;
        }

        .copy-code-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #667eea;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .copy-code-btn:hover {
            background: #5568d3;
        }

        .alert {
            padding: 12px 20px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }

        .alert-success {
            background: #d4edda;
            border-left: 4px solid #28a745;
            color: #155724;
        }

        .alert-error {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
            color: #721c24;
        }

        .alert-info {
            background: #d1ecf1;
            border-left: 4px solid #17a2b8;
            color: #0c5460;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            h1 {
                font-size: 1.5em;
            }

            .section {
                padding: 15px;
            }

            .btn {
                width: 100%;
                margin-right: 0;
            }

            .modal-content {
                width: 95%;
                margin: 10% auto;
                padding: 20px;
            }
        }

        .skill-tag {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            margin: 5px;
            font-size: 14px;
        }

        .tips {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin-top: 15px;
            border-radius: 4px;
        }

        .tips h4 {
            margin-bottom: 10px;
            color: #1976D2;
        }

        .tips ul {
            margin-left: 20px;
        }

        .tips li {
            margin-bottom: 5px;
            color: #555;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Resume Autofill - AI-Powered</h1>
        <p class="subtitle">Optimize your resume for any job using DeepSeek AI</p>

        <div id="alertBox" class="alert"></div>
        <div id="loadingBox" class="loading">
            <div class="spinner"></div>
            <p>Processing with AI...</p>
        </div>

        <!-- API Key Section -->
        <div class="section api-section">
            <h2>üîë DeepSeek API Configuration</h2>
            <div class="form-group">
                <label for="apiKey">DeepSeek API Key:</label>
                <input type="text" id="apiKey" placeholder="sk-..." />
            </div>
            <div class="tips">
                <h4>How to get your API key:</h4>
                <ul>
                    <li>Visit <a href="https://platform.deepseek.com" target="_blank">platform.deepseek.com</a></li>
                    <li>Create an account and navigate to API Keys</li>
                    <li>Generate a new API key and paste it above</li>
                    <li>Your key is stored locally in your browser</li>
                </ul>
            </div>
        </div>

        <!-- Job Analysis Section -->
        <div class="section job-analysis-section">
            <h2>üéØ Job Analysis</h2>
            <div class="form-group">
                <label for="jobUrl">Job Posting URL:</label>
                <input type="text" id="jobUrl" placeholder="https://example.com/job-posting" />
            </div>
            <button class="btn" onclick="analyzeAndFill()">üîç Analyze & Fill</button>
            <button class="btn btn-secondary" onclick="generateUserscript()">üìù Generate Userscript</button>
        </div>

        <!-- Resume Form Section -->
        <div class="section">
            <h2>üìÑ Your Resume</h2>
            
            <!-- Personal Info -->
            <h3 style="margin-bottom: 15px;">Personal Information</h3>
            <div class="grid">
                <div class="form-group">
                    <label for="name">Full Name:</label>
                    <input type="text" id="name" placeholder="John Doe" />
                </div>
                <div class="form-group">
                    <label for="email">Email:</label>
                    <input type="email" id="email" placeholder="john@example.com" />
                </div>
            </div>
            <div class="form-group">
                <label for="phone">Phone:</label>
                <input type="text" id="phone" placeholder="+1 234 567 8900" />
            </div>

            <!-- Skills -->
            <h3 style="margin: 25px 0 15px 0;">Skills</h3>
            <div class="form-group">
                <label for="skills">Skills (comma-separated):</label>
                <textarea id="skills" placeholder="JavaScript, Python, React, Node.js, SQL"></textarea>
            </div>

            <!-- Experience -->
            <h3 style="margin: 25px 0 15px 0;">Work Experience</h3>
            <div id="experienceList"></div>
            <button class="btn btn-secondary btn-small" onclick="addExperience()">+ Add Experience</button>

            <!-- Education -->
            <h3 style="margin: 25px 0 15px 0;">Education</h3>
            <div id="educationList"></div>
            <button class="btn btn-secondary btn-small" onclick="addEducation()">+ Add Education</button>
        </div>

        <!-- Actions -->
        <div class="actions">
            <button class="btn btn-success" onclick="saveResume()">üíæ Save Resume</button>
            <button class="btn" onclick="showPreview()">üëÅÔ∏è Preview</button>
            <button class="btn btn-secondary" onclick="exportJSON()">üì• Export JSON</button>
            <button class="btn btn-secondary" onclick="importJSON()">üì§ Import JSON</button>
            <button class="btn btn-danger" onclick="clearAll()">üóëÔ∏è Clear All</button>
        </div>
    </div>

    <!-- Preview Modal -->
    <div id="previewModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closePreview()">&times;</span>
            <h2 style="margin-bottom: 20px; color: #667eea;">üìã Resume Preview</h2>
            <div id="previewContent"></div>
        </div>
    </div>

    <!-- Userscript Modal -->
    <div id="userscriptModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeUserscript()">&times;</span>
            <h2 style="margin-bottom: 20px; color: #667eea;">üìú Userscript for Tampermonkey/Greasemonkey</h2>
            <p>Copy and paste this script into Tampermonkey or Greasemonkey:</p>
            <div id="userscriptContent"></div>
        </div>
    </div>

    <script>
        // Global state
        let experienceCounter = 0;
        let educationCounter = 0;

        // Initialize on load
        document.addEventListener('DOMContentLoaded', function() {
            loadFromLocalStorage();
            // Add initial experience and education if empty
            if (document.getElementById('experienceList').children.length === 0) {
                addExperience();
            }
            if (document.getElementById('educationList').children.length === 0) {
                addEducation();
            }
        });

        // Show alert message
        function showAlert(message, type = 'info') {
            const alertBox = document.getElementById('alertBox');
            alertBox.className = `alert alert-${type}`;
            alertBox.textContent = message;
            alertBox.style.display = 'block';
            setTimeout(() => {
                alertBox.style.display = 'none';
            }, 5000);
        }

        // Show/hide loading
        function setLoading(show) {
            document.getElementById('loadingBox').style.display = show ? 'block' : 'none';
        }

        // Add experience entry
        function addExperience() {
            const id = experienceCounter++;
            const html = `
                <div class="array-item" id="exp-${id}">
                    <button class="btn btn-danger btn-small remove-btn" onclick="removeElement('exp-${id}')">Remove</button>
                    <div class="form-group">
                        <label>Company:</label>
                        <input type="text" class="exp-company" placeholder="Company Name" />
                    </div>
                    <div class="form-group">
                        <label>Position:</label>
                        <input type="text" class="exp-position" placeholder="Job Title" />
                    </div>
                    <div class="grid">
                        <div class="form-group">
                            <label>Start Date:</label>
                            <input type="text" class="exp-start" placeholder="Jan 2020" />
                        </div>
                        <div class="form-group">
                            <label>End Date:</label>
                            <input type="text" class="exp-end" placeholder="Present" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Description:</label>
                        <textarea class="exp-description" placeholder="Key achievements and responsibilities..."></textarea>
                    </div>
                </div>
            `;
            document.getElementById('experienceList').insertAdjacentHTML('beforeend', html);
        }

        // Add education entry
        function addEducation() {
            const id = educationCounter++;
            const html = `
                <div class="array-item" id="edu-${id}">
                    <button class="btn btn-danger btn-small remove-btn" onclick="removeElement('edu-${id}')">Remove</button>
                    <div class="form-group">
                        <label>Institution:</label>
                        <input type="text" class="edu-institution" placeholder="University Name" />
                    </div>
                    <div class="form-group">
                        <label>Degree:</label>
                        <input type="text" class="edu-degree" placeholder="Bachelor of Science in Computer Science" />
                    </div>
                    <div class="grid">
                        <div class="form-group">
                            <label>Start Year:</label>
                            <input type="text" class="edu-start" placeholder="2016" />
                        </div>
                        <div class="form-group">
                            <label>End Year:</label>
                            <input type="text" class="edu-end" placeholder="2020" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label>GPA/Achievements:</label>
                        <input type="text" class="edu-gpa" placeholder="3.8/4.0, Dean's List" />
                    </div>
                </div>
            `;
            document.getElementById('educationList').insertAdjacentHTML('beforeend', html);
        }

        // Remove element
        function removeElement(id) {
            document.getElementById(id).remove();
        }

        // Get resume data
        function getResumeData() {
            const experiences = [];
            document.querySelectorAll('#experienceList .array-item').forEach(item => {
                experiences.push({
                    company: item.querySelector('.exp-company').value,
                    position: item.querySelector('.exp-position').value,
                    startDate: item.querySelector('.exp-start').value,
                    endDate: item.querySelector('.exp-end').value,
                    description: item.querySelector('.exp-description').value
                });
            });

            const education = [];
            document.querySelectorAll('#educationList .array-item').forEach(item => {
                education.push({
                    institution: item.querySelector('.edu-institution').value,
                    degree: item.querySelector('.edu-degree').value,
                    startYear: item.querySelector('.edu-start').value,
                    endYear: item.querySelector('.edu-end').value,
                    gpa: item.querySelector('.edu-gpa').value
                });
            });

            return {
                name: document.getElementById('name').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                skills: document.getElementById('skills').value.split(',').map(s => s.trim()).filter(s => s),
                experience: experiences,
                education: education
            };
        }

        // Set resume data
        function setResumeData(data) {
            document.getElementById('name').value = data.name || '';
            document.getElementById('email').value = data.email || '';
            document.getElementById('phone').value = data.phone || '';
            document.getElementById('skills').value = (data.skills || []).join(', ');

            // Clear existing
            document.getElementById('experienceList').innerHTML = '';
            document.getElementById('educationList').innerHTML = '';

            // Add experiences
            if (data.experience && data.experience.length > 0) {
                data.experience.forEach(exp => {
                    addExperience();
                    const items = document.querySelectorAll('#experienceList .array-item');
                    const item = items[items.length - 1];
                    item.querySelector('.exp-company').value = exp.company || '';
                    item.querySelector('.exp-position').value = exp.position || '';
                    item.querySelector('.exp-start').value = exp.startDate || '';
                    item.querySelector('.exp-end').value = exp.endDate || '';
                    item.querySelector('.exp-description').value = exp.description || '';
                });
            }

            // Add education
            if (data.education && data.education.length > 0) {
                data.education.forEach(edu => {
                    addEducation();
                    const items = document.querySelectorAll('#educationList .array-item');
                    const item = items[items.length - 1];
                    item.querySelector('.edu-institution').value = edu.institution || '';
                    item.querySelector('.edu-degree').value = edu.degree || '';
                    item.querySelector('.edu-start').value = edu.startYear || '';
                    item.querySelector('.edu-end').value = edu.endYear || '';
                    item.querySelector('.edu-gpa').value = edu.gpa || '';
                });
            }
        }

        // Save to localStorage
        function saveResume() {
            const data = getResumeData();
            const apiKey = document.getElementById('apiKey').value;
            
            localStorage.setItem('resumeData', JSON.stringify(data));
            localStorage.setItem('deepseekApiKey', apiKey);
            
            showAlert('Resume saved successfully!', 'success');
        }

        // Load from localStorage
        function loadFromLocalStorage() {
            const saved = localStorage.getItem('resumeData');
            const apiKey = localStorage.getItem('deepseekApiKey');
            
            if (apiKey) {
                document.getElementById('apiKey').value = apiKey;
            }
            
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    setResumeData(data);
                } catch (e) {
                    console.error('Error loading saved data:', e);
                }
            }
        }

        // Fetch job description via CORS proxy
        async function fetchJobDescription(url) {
            const corsProxies = [
                `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`,
                `https://corsproxy.io/?${encodeURIComponent(url)}`,
                `https://cors-anywhere.herokuapp.com/${url}`
            ];

            for (let proxyUrl of corsProxies) {
                try {
                    const response = await fetch(proxyUrl);
                    if (response.ok) {
                        const data = await response.json();
                        // Handle different proxy response formats
                        return data.contents || data.data || data;
                    }
                } catch (e) {
                    console.warn('Proxy failed:', proxyUrl, e);
                }
            }

            throw new Error('All CORS proxies failed. Please try copying the job description manually.');
        }

        // Call DeepSeek API
        async function callDeepSeekAPI(jobDescription, resumeData) {
            const apiKey = document.getElementById('apiKey').value;
            
            if (!apiKey) {
                throw new Error('Please enter your DeepSeek API key');
            }

            const prompt = `You are an expert resume optimizer. Analyze the following job description and the candidate's resume, then provide optimized content.

Job Description:
${jobDescription}

Current Resume:
${JSON.stringify(resumeData, null, 2)}

Please provide:
1. Optimized skills list that matches the job requirements (include ATS keywords)
2. Suggested improvements for each work experience description to highlight relevant achievements
3. Key ATS keywords to include
4. Overall matching score (0-100)

Respond in JSON format:
{
  "optimizedSkills": ["skill1", "skill2", ...],
  "experienceImprovements": [
    {"index": 0, "suggestion": "improved description"},
    ...
  ],
  "atsKeywords": ["keyword1", "keyword2", ...],
  "matchingScore": 85,
  "recommendations": "Overall recommendations text"
}`;

            const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: 'deepseek-chat',
                    messages: [
                        {
                            role: 'user',
                            content: prompt
                        }
                    ],
                    temperature: 0.7,
                    max_tokens: 2000
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'DeepSeek API request failed');
            }

            const result = await response.json();
            const content = result.choices[0].message.content;
            
            // Extract JSON from response (handle markdown code blocks)
            const jsonMatch = content.match(/\{[\s\S]*\}/);
            if (jsonMatch) {
                return JSON.parse(jsonMatch[0]);
            }
            
            throw new Error('Failed to parse API response');
        }

        // Analyze and fill
        async function analyzeAndFill() {
            const jobUrl = document.getElementById('jobUrl').value.trim();
            
            if (!jobUrl) {
                showAlert('Please enter a job URL', 'error');
                return;
            }

            try {
                setLoading(true);
                showAlert('Fetching job description...', 'info');

                // Fetch job description
                let jobDescription;
                try {
                    jobDescription = await fetchJobDescription(jobUrl);
                    if (typeof jobDescription === 'object') {
                        jobDescription = JSON.stringify(jobDescription);
                    }
                } catch (e) {
                    showAlert('Could not fetch job description automatically. Please copy it manually and paste below.', 'error');
                    const manualInput = prompt('Paste the job description here:');
                    if (!manualInput) {
                        setLoading(false);
                        return;
                    }
                    jobDescription = manualInput;
                }

                showAlert('Analyzing with DeepSeek AI...', 'info');

                // Get current resume data
                const resumeData = getResumeData();

                // Call DeepSeek API
                const analysis = await callDeepSeekAPI(jobDescription, resumeData);

                // Apply optimizations
                if (analysis.optimizedSkills) {
                    document.getElementById('skills').value = analysis.optimizedSkills.join(', ');
                }

                if (analysis.experienceImprovements) {
                    const expItems = document.querySelectorAll('#experienceList .array-item');
                    analysis.experienceImprovements.forEach(improvement => {
                        if (expItems[improvement.index]) {
                            const currentDesc = expItems[improvement.index].querySelector('.exp-description').value;
                            expItems[improvement.index].querySelector('.exp-description').value = 
                                improvement.suggestion + '\n\n' + currentDesc;
                        }
                    });
                }

                setLoading(false);
                
                // Show results
                let message = `Analysis complete!\nMatching Score: ${analysis.matchingScore}%\n`;
                if (analysis.atsKeywords) {
                    message += `\nATS Keywords: ${analysis.atsKeywords.join(', ')}`;
                }
                if (analysis.recommendations) {
                    message += `\n\nRecommendations: ${analysis.recommendations}`;
                }
                
                alert(message);
                showAlert('Resume optimized successfully!', 'success');

            } catch (error) {
                setLoading(false);
                showAlert('Error: ' + error.message, 'error');
                console.error(error);
            }
        }

        // Show preview
        function showPreview() {
            const data = getResumeData();
            let html = '<div>';

            // Personal Info
            html += '<div class="preview-section">';
            html += '<h3>Personal Information</h3>';
            html += `<p><strong>Name:</strong> ${data.name || 'N/A'}</p>`;
            html += `<p><strong>Email:</strong> ${data.email || 'N/A'}</p>`;
            html += `<p><strong>Phone:</strong> ${data.phone || 'N/A'}</p>`;
            html += '</div>';

            // Skills
            html += '<div class="preview-section">';
            html += '<h3>Skills</h3>';
            if (data.skills && data.skills.length > 0) {
                data.skills.forEach(skill => {
                    html += `<span class="skill-tag">${skill}</span>`;
                });
            } else {
                html += '<p>No skills added</p>';
            }
            html += '</div>';

            // Experience
            html += '<div class="preview-section">';
            html += '<h3>Work Experience</h3>';
            if (data.experience && data.experience.length > 0) {
                data.experience.forEach(exp => {
                    html += '<div class="preview-item">';
                    html += `<h4>${exp.position || 'Position'} at ${exp.company || 'Company'}</h4>`;
                    html += `<p><em>${exp.startDate || ''} - ${exp.endDate || ''}</em></p>`;
                    html += `<p>${exp.description || ''}</p>`;
                    html += '</div>';
                });
            } else {
                html += '<p>No experience added</p>';
            }
            html += '</div>';

            // Education
            html += '<div class="preview-section">';
            html += '<h3>Education</h3>';
            if (data.education && data.education.length > 0) {
                data.education.forEach(edu => {
                    html += '<div class="preview-item">';
                    html += `<h4>${edu.degree || 'Degree'}</h4>`;
                    html += `<p><strong>${edu.institution || 'Institution'}</strong></p>`;
                    html += `<p><em>${edu.startYear || ''} - ${edu.endYear || ''}</em></p>`;
                    if (edu.gpa) {
                        html += `<p>${edu.gpa}</p>`;
                    }
                    html += '</div>';
                });
            } else {
                html += '<p>No education added</p>';
            }
            html += '</div>';

            html += '</div>';

            document.getElementById('previewContent').innerHTML = html;
            document.getElementById('previewModal').style.display = 'block';
        }

        // Close preview
        function closePreview() {
            document.getElementById('previewModal').style.display = 'none';
        }

        // Export JSON
        function exportJSON() {
            const data = getResumeData();
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'resume.json';
            a.click();
            URL.revokeObjectURL(url);
            showAlert('Resume exported successfully!', 'success');
        }

        // Import JSON
        function importJSON() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'application/json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const data = JSON.parse(event.target.result);
                        setResumeData(data);
                        showAlert('Resume imported successfully!', 'success');
                    } catch (error) {
                        showAlert('Error importing JSON: ' + error.message, 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // Clear all
        function clearAll() {
            if (confirm('Are you sure you want to clear all data?')) {
                document.getElementById('name').value = '';
                document.getElementById('email').value = '';
                document.getElementById('phone').value = '';
                document.getElementById('skills').value = '';
                document.getElementById('experienceList').innerHTML = '';
                document.getElementById('educationList').innerHTML = '';
                addExperience();
                addEducation();
                showAlert('All data cleared', 'info');
            }
        }

        // Generate Userscript
        function generateUserscript() {
            const resumeData = getResumeData();
            const apiKey = document.getElementById('apiKey').value;

            const script = `// ==UserScript==
// @name         Resume Autofill Helper
// @namespace    http://tampermonkey.net/
// @version      1.0
// @description  Auto-fill resume data on job application forms
// @author       You
// @match        *://*/*
// @grant        none
// ==/UserScript==

(function() {
    'use strict';

    // Resume data
    const resumeData = ${JSON.stringify(resumeData, null, 4)};

    // Helper function to fill input
    function fillInput(selector, value) {
        const elements = document.querySelectorAll(selector);
        elements.forEach(el => {
            if (el.type === 'checkbox' || el.type === 'radio') {
                el.checked = value;
            } else {
                el.value = value;
                el.dispatchEvent(new Event('input', { bubbles: true }));
                el.dispatchEvent(new Event('change', { bubbles: true }));
            }
        });
    }

    // Create autofill button
    const button = document.createElement('button');
    button.textContent = 'üöÄ Autofill Resume';
    button.style.cssText = 'position: fixed; top: 10px; right: 10px; z-index: 10000; padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 12px rgba(0,0,0,0.3);';
    
    button.onclick = function() {
        // Try to fill common field names
        fillInput('input[name*="name"], input[id*="name"], input[placeholder*="name"]', resumeData.name);
        fillInput('input[name*="email"], input[id*="email"], input[type="email"]', resumeData.email);
        fillInput('input[name*="phone"], input[id*="phone"], input[type="tel"]', resumeData.phone);
        
        // Fill skills
        if (resumeData.skills && resumeData.skills.length > 0) {
            fillInput('textarea[name*="skill"], textarea[id*="skill"], input[name*="skill"]', resumeData.skills.join(', '));
        }

        alert('Autofill attempted! Some fields may require manual adjustment.');
    };

    document.body.appendChild(button);

    console.log('Resume Autofill Helper loaded!');
    console.log('Resume data:', resumeData);
})();`;

            const html = `
                <div class="code-block">
                    <button class="copy-code-btn" onclick="copyUserscript()">Copy</button>
                    <pre>${escapeHtml(script)}</pre>
                </div>
                <div class="tips">
                    <h4>How to use:</h4>
                    <ul>
                        <li>Install <a href="https://www.tampermonkey.net/" target="_blank">Tampermonkey</a> (Chrome/Edge/Firefox) or <a href="https://www.greasespot.net/" target="_blank">Greasemonkey</a> (Firefox)</li>
                        <li>Click the extension icon and select "Create a new script"</li>
                        <li>Delete the default content and paste this script</li>
                        <li>Save (Ctrl+S or Cmd+S)</li>
                        <li>Visit any job application page and click the "üöÄ Autofill Resume" button</li>
                    </ul>
                </div>
            `;

            document.getElementById('userscriptContent').innerHTML = html;
            document.getElementById('userscriptModal').style.display = 'block';

            // Store script for copying
            window.currentUserscript = script;
        }

        // Copy userscript
        function copyUserscript() {
            const script = window.currentUserscript;
            navigator.clipboard.writeText(script).then(() => {
                showAlert('Userscript copied to clipboard!', 'success');
            }).catch(err => {
                console.error('Failed to copy:', err);
                showAlert('Failed to copy. Please select and copy manually.', 'error');
            });
        }

        // Close userscript modal
        function closeUserscript() {
            document.getElementById('userscriptModal').style.display = 'none';
        }

        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        };

        // Auto-save on change (debounced)
        let saveTimeout;
        document.addEventListener('input', function() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                const data = getResumeData();
                localStorage.setItem('resumeData', JSON.stringify(data));
            }, 2000);
        });
    </script>
</body>
</html>
